<script type="text/javascript">
  jQuery(document).ready(function() {
      jQuery('#mycarousel').jcarousel();
  });
</script>

<% @pagetitle = page_title %>

<!-- Helper put in place but not finished -->
<% @share_url = document_url(@document)%>
<% if !@document.blank? && !@document.document_photos.blank? %>
  <% @fb_img = @document.default_image.photo.url(:thumb)%>
<% end%>
<% @share_data=""%>
<% if @document.name.blank? %>
  <% @share_data=@document.try(:title) %>
  <% @share_description = @document.try(:title) %>
<% else %>
  <% @share_data=@document.try(:name) %>
  <% @share_description = @document.try(:name) %>
  <%# for facebook check head section of layout/application.html.erb %>
<% end %>

<% increment_view_counter %>

<div>

  <div class="well">
    <div class="row-fluid">
      <div class="span11">
        <h4><%= page_title %></h4>
      </div>
    	<% if @document.is_featured %>
        <div class="span1"><span class="pull-right"><%= image_tag("icons/star.gif", :title=>"This is a featured item")%></span></div>
      <% end%>
    </div>
    
    <div class=row-fluid">    
      <% if site.selling_enabled %>
        <% if !current_user %>
          <strong class="text-error">You must be logged in to see sale and purchasing information about this item</strong>
        <%else%>
          <% if @document.is_on_sale? && !@document.sale_price.blank? && @document.sale_price > 0.50 %>
            <strong class="">This item is for sale</strong>
            <strong class="pull-right">
              <%= number_to_currency(@document.try(:sale_price), :unit => " &pound;").html_safe unless @document.sale_price.blank? %> 
              <% if @document.shipping_price == 0 %>
                (Free Shipping)
              <%else%>
                (+ <%= number_to_currency(@document.shipping_price, :unit => "&pound;") %> P&P)
              <%end%>
            </strong>
          <%else%>
            <strong >This item is not for sale</strong>
          <% end %>	
        <%end%>
      <%else%>
        <strong>Selling is currently not enabled on this site</strong>
      <%end%>
    </div>   
  </div>

  <div class="row-fluid">
    <% if !current_user.blank? && (current_user.is_document_owner(@document.user_id) || current_user.is_admin) %>
     	<div class="span3"><%= link_to '<i class="icon-edit icon-white"></i> Edit Document'.html_safe, edit_document_path(@document),:class=>"ajaxmodal btn btn-primary" %></div><br /><br />
    <% else %>

      <% if current_user %>
        <% if current_user.location_country.name == "United Kingdom" %>
          <% if site.selling_enabled && @document.is_on_sale? && !@document.sale_price.blank? && @document.sale_price > 0.50   %>
            <div class="span1">
            	<% payment_service_for @document.id, PAYPAL_ACCOUNT, 
                  :amount => @document.sale_price, 
                  :currency => 'GBP', 
                  :service => :paypal, 
                  :html => { :id => 'payment-form' } do |service| %>
                <% service.customer :first_name => current_user.first_name, 
                                    :last_name => current_user.last_name,
                                    :email => current_user.email %>
                <% service.billing_address  :city => current_user.city, 
                                            :address1 => current_user.address1, 
                                            :address2 => current_user.address2,
                                            :state => current_user.county,
                                            :zip => current_user.post_code %>

                <% service.item_name  @pagetitle %>
                <% service.shipping @document.shipping_price %>
                <% service.tax '0.00' %>
                <% service.notify_url paypal_ipn_url %>
                <% service.return_url paypal_return_url %>
                <% service.cancel_return_url paypal_cancel_url %> 
                <% submit_tag("Buy Item",:class=>"btn btn-primary") %>
            	<% end %>
            </div>
            <div class="span2">
              <span class="pull-right"><%= link_to '<i class="icon-envelope icon-white"></i> Make offer'.html_safe ,offer_new_path(:document_id => @document.id),:class=>"ajaxmodal btn btn-primary",:remote=>true%></span>
            </div>
          <%end%>
        <%else%>
          <div class="well">
            We can only process orders from the UK at the moment. We are working on this right now.  
            If you'd like to buy this item, please <%= link_to "contact us","http://blog.pastonpaper.com/contact/" %> quoting reference <%= @document.reference_number %>
          </div>
        <%end%>
	    <%end%>
    <%end%>
  </div>

  <div class="row-fluid">

    <div class="span6">
      <h4>Item Details</h4>

      <% unless @document.document_type.blank? %>
        <div class="row-fluid">
          <span class="span2 strong">Type</span><%= @document.document_type.try(:name) %>
        </div>
      <%end%>
      
      <% unless @document.title.blank? %>
        <div class="row-fluid">
          <span class="span2 strong">Title</span><%= @document.title %>
        </div>
      <% end %>

      <% @document.attribute_documents.group_by { |d| d.attribute_type.try(:name) }.each_pair do |type, doc_attrs| %>
        <div class="row-fluid">
          <span class="span2 strong"><%= type %></span>
          <% doc_attrs.each do |doc_attr| %>
            <%= "  #{doc_attr.value}" %>
            <%= ", #{doc_attr.attribute_location}" unless doc_attr.attribute_location.blank? %>
            <%= ", #{doc_attr.attribute_year}" unless doc_attr.attribute_year.blank? %><br />
          <% end %>
        </div>
      <% end %> 

      <div class="row-fluid">
        <% unless @document.condition.blank? %>
          <span class="span2 strong">Condition</span><%= @document.try(:condition) %>
        <% else %>
          <span>A condition report has not been provided for this item</span><br /><br />
        <%end%>
      </div>

      <div class="row-fluid">    
        <% if !@document.weight.blank? %>            
       	  <span class="span2 strong">Weight</span><%= "#{@document.try(:weight)}g" unless @document.weight.blank?%>
        <% else %>
          <span>No weight details have been provided for this item</span><br />
        <%end%>
      </div>

      <div class="row-fluid">   
        <% if !@document.length.blank? || !@document.width.blank? || !@document.depth.blank? %>      	
          <span class="strong">Dimensions</span><br>
          <span><%= "#{@document.try(:length)}mm (length) " unless @document.length.blank? %> <%= "#{@document.try(:width)}mm (width)" unless @document.width.blank? %> <%= "#{@document.try(:depth)}mm (depth)" unless @document.depth.blank? %></span>
        <% else %>
          <span>No dimensions have been provided for this item</span><br />
        <% end %>
      </div>


      
      <% if @document.tag_list.present? %>
        <small><%= @document.tag_list %></small>
        <br />
      <%end%>
	    <br />

      <% if @document.document_type.name == "Bible" %>
        The Family Register lists <%= @document.people.count %> individuals<br />
        <br /><br />
      <% end %>

      Listed by <%= @document.user.username %> on <%= @document.created_at.strftime("%d/%m/%Y")%><br />
	    Reference Number: <%= @document.reference_number %><br />
      <br /><br />
      <%= render :partial => "shared/social_share"%> 
      <span class="btn btn-mini" style="position:relative;left:4px; top: 3px;">Views: <%= @document.views+1 %></span>

    </div>  

    <div class="span6">
	    <% if !@document.blank? && !@document.document_photos.blank? %>
	      <ul class="thumbnails">
          <li class="span12"><%= image_tag @document.default_image.photo.url(:large) ,:class=>"thumbnail"%></li> 
          <% if @document.document_photos.count > 1 %>
            <% @document.document_photos.each do |photo|  %>
              <li class="span2" style="">
                <a href="<%= photo.photo.url(:large) %>" class='thumbnail' rel="lightbox"><%= image_tag photo.photo.url(:small)%></a>
              </li>
            <% end %>
          <% end %>
        </ul>
      <% end %>
    </div>

  </div>

  <% unless @document.comment.blank? %>
    <div class="row-fluid">
        <h4>Item Description</h4>
        <%= @document.try(:comment).html_safe %>
        <br /><br />
    </div>
  <%end%>

  <% if !current_user %>
    <div class="hero-unit">
      <% if @document.document_type.name == "Bible" %>
        <div class="row-fluid">
          <center><h3>The Family Register in this Bible lists <%= @document.people.count %> individuals</h3></center>
          <div class="span6 offset3"><h6>The following surnames are listed: Lorem ipsum dolor sit amet, consectetur adipiscing elit</h6></div>
        </div>
      <%end%>
      <div class="row-fluid">
        <center><h4 class="text-error">You must be a member of pastonpaper.com to see extended details</h4></center>
      </div>
      <div class="row-fluid">
        <center>
          <h5>Please <a class="text-error" href="#loginModal" data-backdrop="static" data-toggle="modal" data-backdrop="static">Login</a>
          or <%= link_to "Register",register_path, :class=>"text-error", :id=>"registerUser", :style => "text-error"%></h5>
        </center> 
      </div>      
      <div class="row-fluid">
        <div class="span6 offset3">
          Registration is free, and gives you unlimited access to our database of genealogical data.  You can also buy, sell and make offers on any item listed on our site</blockquote>
        </div>
      </div>
    </div>
    <div class="rowfluid">
      <div class="well">
        <center><%= banner_ads[rand(banner_ads.count)].html_safe %></center>
      </div>
    </div>

  <%else%>
    <div>
     	<%= render "document_extended_details" %>
    </div>
  <%end%>

</div>
